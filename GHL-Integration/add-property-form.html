<!-- 
  GOHIGHLEVEL ADD PROPERTY FORM
  This allows users to submit new properties directly to Airtable
-->

<style>
  .add-property-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
  }

  .form-card {
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .form-section {
    margin-bottom: 30px;
    padding-bottom: 30px;
    border-bottom: 2px solid #e5e7eb;
  }

  .form-section:last-of-type {
    border-bottom: none;
  }

  .form-section h3 {
    margin-bottom: 20px;
    color: #1f2937;
    font-size: 20px;
  }

  .form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
  }

  .form-group {
    margin-bottom: 15px;
  }

  .form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 5px;
    color: #374151;
  }

  .form-group input,
  .form-group select,
  .form-group textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
    font-family: inherit;
  }

  .form-group textarea {
    min-height: 100px;
    resize: vertical;
  }

  .form-group small {
    display: block;
    margin-top: 5px;
    color: #6b7280;
    font-size: 12px;
  }

  .submit-btn {
    background: #2563eb;
    color: white;
    padding: 12px 30px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 16px;
    width: 100%;
    transition: background 0.3s;
  }

  .submit-btn:hover {
    background: #1e40af;
  }

  .submit-btn:disabled {
    background: #9ca3af;
    cursor: not-allowed;
  }

  .message {
    padding: 15px;
    border-radius: 6px;
    margin-top: 20px;
    text-align: center;
    font-weight: 600;
  }

  .message.success {
    background: #d1fae5;
    color: #065f46;
  }

  .message.error {
    background: #fee2e2;
    color: #991b1b;
  }

  .message.info {
    background: #dbeafe;
    color: #1e40af;
  }

  @media (max-width: 768px) {
    .form-row {
      grid-template-columns: 1fr;
    }
  }
</style>

<div class="add-property-container">
  <div class="form-card">
    <h2 style="margin-bottom: 10px;">List Your Property</h2>
    <p style="color: #6b7280; margin-bottom: 30px;">Fill out the form below to add your property listing</p>

    <form id="addPropertyForm">
      <!-- Basic Information -->
      <div class="form-section">
        <h3>Basic Information</h3>
        
        <div class="form-group">
          <label>Property Title *</label>
          <input type="text" id="title" required placeholder="e.g., Beautiful Family Home">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Property Type *</label>
            <select id="propertyType" required>
              <option value="">Select Type</option>
              <option value="House">House</option>
              <option value="Apartment">Apartment</option>
              <option value="Condo">Condo</option>
              <option value="Townhouse">Townhouse</option>
              <option value="Villa">Villa</option>
            </select>
          </div>

          <div class="form-group">
            <label>Price (USD) *</label>
            <input type="number" id="price" required placeholder="450000" min="0">
          </div>
        </div>

        <div class="form-group">
          <label>Full Address *</label>
          <input type="text" id="location" required placeholder="123 Main St, City, State, ZIP">
        </div>

        <div class="form-group">
          <label>Status *</label>
          <select id="status" required>
            <option value="Available">Available</option>
            <option value="Pending">Pending</option>
            <option value="Sold">Sold</option>
          </select>
        </div>
      </div>

      <!-- Property Details -->
      <div class="form-section">
        <h3>Property Details</h3>
        
        <div class="form-row">
          <div class="form-group">
            <label>Bedrooms</label>
            <input type="number" id="bedrooms" placeholder="4" min="0">
          </div>

          <div class="form-group">
            <label>Bathrooms</label>
            <input type="number" id="bathrooms" placeholder="3" min="0" step="0.5">
          </div>

          <div class="form-group">
            <label>Square Feet</label>
            <input type="number" id="squareFeet" placeholder="2500" min="0">
          </div>

          <div class="form-group">
            <label>Year Built</label>
            <input type="number" id="yearBuilt" placeholder="2020" min="1800" max="2030">
          </div>
        </div>
      </div>

      <!-- Description & Media -->
      <div class="form-section">
        <h3>Description & Media</h3>
        
        <div class="form-group">
          <label>Property Description *</label>
          <textarea id="description" required placeholder="Describe your property, highlight key features..."></textarea>
          <small>Provide a detailed description to attract potential buyers</small>
        </div>

        <div class="form-group">
          <label>Image URL</label>
          <input type="url" id="imageUrl" placeholder="https://example.com/property-image.jpg">
          <small>Provide a direct link to an image of your property</small>
        </div>

        <div class="form-group">
          <label>Amenities</label>
          <textarea id="amenities" rows="3" placeholder="Pool, Gym, Parking, Garden"></textarea>
          <small>List amenities separated by commas</small>
        </div>
      </div>

      <button type="submit" class="submit-btn" id="submitBtn">Add Property</button>
      
      <div id="message" style="display: none;"></div>
    </form>
  </div>
</div>

<script>
  // ⚠️ IMPORTANT: Replace these with your actual Airtable credentials
  const AIRTABLE_CONFIG = {
    apiKey: 'YOUR_AIRTABLE_API_TOKEN',
    baseId: 'YOUR_BASE_ID',
    tableName: 'Properties'
  };

  document.getElementById('addPropertyForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const submitBtn = document.getElementById('submitBtn');
    const messageEl = document.getElementById('message');

    // Collect form data
    const propertyData = {
      Title: document.getElementById('title').value,
      'Property Type': document.getElementById('propertyType').value,
      Price: parseFloat(document.getElementById('price').value),
      Location: document.getElementById('location').value,
      Status: document.getElementById('status').value,
      Description: document.getElementById('description').value
    };

    // Add optional fields if they have values
    const bedrooms = document.getElementById('bedrooms').value;
    if (bedrooms) propertyData.Bedrooms = parseInt(bedrooms);

    const bathrooms = document.getElementById('bathrooms').value;
    if (bathrooms) propertyData.Bathrooms = parseFloat(bathrooms);

    const squareFeet = document.getElementById('squareFeet').value;
    if (squareFeet) propertyData['Square Feet'] = parseInt(squareFeet);

    const yearBuilt = document.getElementById('yearBuilt').value;
    if (yearBuilt) propertyData['Year Built'] = parseInt(yearBuilt);

    const imageUrl = document.getElementById('imageUrl').value;
    if (imageUrl) propertyData.Image = [{ url: imageUrl }];

    const amenities = document.getElementById('amenities').value;
    if (amenities) propertyData.Amenities = amenities;

    try {
      // Disable button and show loading
      submitBtn.disabled = true;
      submitBtn.textContent = 'Adding Property...';
      showMessage('Adding property...', 'info');

      // Send to Airtable
      const response = await fetch(
        `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.tableName}`,
        {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            fields: propertyData
          })
        }
      );

      if (!response.ok) {
        const error = await response.json();
        console.error('Airtable Error Response:', error);
        console.error('Status:', response.status);
        console.error('Request was to:', `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.tableName}`);
        throw new Error(error.error?.message || error.error?.type || 'Failed to add property');
      }

      // Success!
      showMessage('Property added successfully!', 'success');
      document.getElementById('addPropertyForm').reset();

      // Optional: Redirect after 2 seconds
      setTimeout(() => {
        // window.location.href = '/properties'; // Redirect to properties page
      }, 2000);

    } catch (error) {
      console.error('Error:', error);
      let errorMessage = 'Failed to add property. ';
      
      if (error.message.includes('permissions') || error.message.includes('not found')) {
        errorMessage += 'Permission denied. Please check:\n' +
                       '1. Token has data.records:write permission\n' +
                       '2. Base is added to token access\n' +
                       '3. Table name is correct: property_listing';
      } else {
        errorMessage += error.message;
      }
      
      showMessage(errorMessage, 'error');
    } finally {
      // Re-enable button
      submitBtn.disabled = false;
      submitBtn.textContent = 'Add Property';
    }
  });

  function showMessage(text, type) {
    const messageEl = document.getElementById('message');
    messageEl.textContent = text;
    messageEl.className = `message ${type}`;
    messageEl.style.display = 'block';

    // Auto-hide info messages
    if (type === 'info') {
      setTimeout(() => {
        messageEl.style.display = 'none';
      }, 3000);
    }
  }
</script>
